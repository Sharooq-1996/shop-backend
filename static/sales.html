<script>

/* PRODUCTS */
const products = [
{name:"Gents Belt Watch",category:"watch",img:"gents-belt.png"},
{name:"Gents Chain Watch",category:"watch",img:"gents-chain.png"},
{name:"Ladies Belt Watch",category:"watch",img:"ladies-belt.png"},
{name:"Ladies Chain Watch",category:"watch",img:"ladies-chain.png"},
{name:"Wall Clock",category:"clock",img:"wall-clock.png"},
{name:"Alarm Timepiece",category:"clock",img:"alarm.png"},
{name:"Strap",category:"accessory",img:"straps.png"},
{name:"Chain",category:"accessory",img:"chain.png"},
{name:"Repair",category:"repair",img:"repair.png"},
{name:"Watch Cell",category:"accessory",img:"watch-cell.png"}
];

/* LOAD PRODUCTS */
function loadProducts(category="all"){
    const grid=document.getElementById("productGrid");
    grid.innerHTML="";
    products.forEach(p=>{
        if(category==="all"||p.category===category){
            grid.innerHTML+=`
            <div class="product-item" onclick="selectProduct('${p.name}')">
                <img src="${p.img}">
                <p>${p.name}</p>
            </div>`;
        }
    });
}

/* SELECT PRODUCT */
function selectProduct(name){
    document.getElementById("productName").value=name;
    document.getElementById("quantity").value=1;
    document.getElementById("price").value="";
    document.getElementById("totalAmount").value="";
}

/* QTY CHANGE */
function changeQty(val){
    let qty=parseInt(quantity.value)||1;
    qty+=val;
    if(qty<1) qty=1;
    quantity.value=qty;
    calculateTotal();
}

/* TOTAL CALCULATION */
function calculateTotal(){
    const priceVal=parseFloat(price.value)||0;
    const qtyVal=parseInt(quantity.value)||0;
    totalAmount.value=priceVal*qtyVal;
}

price.addEventListener("input",calculateTotal);
quantity.addEventListener("input",calculateTotal);

/* ADD SALE */
function addSale(){

    if(!productName.value){
        alert("Please select a product");
        return;
    }

    if(!price.value){
        alert("Please enter price");
        return;
    }

    const sale={
        customerName:customerName.value,
        productName:productName.value,
        quantity:+quantity.value,
        price:+price.value,
        paymentMethod:paymentMethod.value
    };

    fetch("/sales/create",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(sale)
    })
    .then(res=>res.json())
    .then(()=>{
        customerName.value="";
        productName.value="";
        quantity.value=1;
        price.value="";
        totalAmount.value="";
        paymentMethod.value="CASH";
        loadSales();
    });
}

/* LOAD SALES */
function loadSales(){
    fetch("/sales")
    .then(r=>r.json())
    .then(data=>{

        const today=new Date().toISOString().split("T")[0];
        let total=0;
        let count=0;

        const tbody=document.getElementById("salesBody");
        tbody.innerHTML="";

        data.forEach(sale=>{

            const saleDate=new Date(sale.createdDate)
                .toISOString()
                .split("T")[0];

            if(saleDate===today){

                count++;
                total+=sale.price*sale.quantity;

                tbody.innerHTML+=`
                <tr>
                    <td>${sale.saleId}</td>
                    <td>${sale.customerName}</td>
                    <td>${sale.productName}</td>
                    <td>${sale.quantity}</td>
                    <td>${sale.price}</td>
                    <td>${sale.paymentMethod}</td>
                    <td>${new Date(sale.createdDate).toLocaleString("en-IN")}</td>
                    <td>
                        <button class="print-btn"
                        onclick='printBill(${JSON.stringify(sale)})'>
                        Print
                        </button>
                    </td>
                </tr>`;
            }
        });

        document.getElementById("count").innerText=count;
        document.getElementById("amount").innerText=total.toFixed(2);
    });
}

/* PRINT BILL */
function printBill(sale){

    const win=window.open('', '', 'width=300,height=600');

    win.document.write(`
    <html>
    <head>
    <style>
    body{font-family:monospace;padding:10px;}
    hr{border:1px dashed #000;}
    </style>
    </head>
    <body>
    <h3 style="text-align:center;">AYAN WATCH & ELECTRONICS</h3>
    <hr>
    Customer: ${sale.customerName}<br>
    Product: ${sale.productName}<br>
    Qty: ${sale.quantity}<br>
    Price: â‚¹${sale.price}<br>
    Payment: ${sale.paymentMethod}<br>
    Date: ${new Date(sale.createdDate).toLocaleString("en-IN")}
    <hr>
    <p style="text-align:center;">Thank you!</p>
    </body>
    </html>
    `);

    win.document.close();
    win.print();
    win.close();
}

/* INITIAL LOAD */
loadProducts();
loadSales();

</script>
